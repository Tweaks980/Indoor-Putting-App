<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
<title>Indoor Putting — Practice & Stats</title>
<style>
  :root{
    --bg:#0f1115; --panel:#1a1f24; --panel-2:#11161b; --text:#e8ecf1;
    --muted:#9aa7b2; --accent:#2ea043; --accent-2:#3b82f6; --btn:#2b3138;
    --border:#2a3138; --radius:14px; color-scheme:dark; --nav-h:64px;
    --danger:#991b1b;
  }
  *{box-sizing:border-box}
  html,body{-webkit-text-size-adjust:100%}
  body{margin:0;background:var(--bg);color:var(--text);
    font-family:-apple-system,BlinkMacSystemFont,Inter,Arial,sans-serif;
    padding-bottom:calc(var(--nav-h) + env(safe-area-inset-bottom) + 8px);}
  input,select,textarea{font-size:16px!important}
  .wrap{max-width:420px;margin:0 auto;padding:12px}
  .hidden{display:none}
  h1{margin:0 0 6px;font-size:20px;font-weight:800;text-align:center}
  h2{margin:0 0 8px;font-size:14px;color:var(--muted);font-weight:700}
  .muted{color:var(--muted);font-size:13px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin:6px 0}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .field{display:grid;gap:6px}
  .lbl{font-size:12px;color:var(--muted);font-weight:700}
  .input,.pill{background:var(--panel-2);border:1px solid var(--border);border-radius:12px;padding:10px 12px;color:var(--text);display:flex;align-items:center;justify-content:space-between}
  .input input,.input select{background:transparent;border:none;outline:none;color:var(--text);width:100%}
  .btn{background:var(--btn);color:var(--text);border:1px solid var(--border);padding:10px 12px;border-radius:12px;cursor:pointer;display:inline-flex;gap:8px;align-items:center;justify-content:center;font-weight:800;text-decoration:none;touch-action:manipulation}
  .btn.primary{background:var(--accent-2);color:#fff;border:none}
  .btn.success{background:var(--accent);color:#fff;border:none}
  .btn.danger{background:linear-gradient(180deg,#991b1b,#450a0a);color:#fff;border-color:#5f0a0a}
  table{width:100%;border-collapse:collapse;font-size:12px}
  th,td{padding:10px 8px;border-bottom:1px solid var(--border);text-align:left}
  th{color:#fff;font-weight:700}
  th.right,td.right{text-align:right}
  .tight th,.tight td{padding:8px}

  /* Steppers */
  .stepper{display:grid;grid-template-columns:36px minmax(0,1fr) 36px;gap:8px;align-items:center}
  .stepper .step{width:36px;height:36px;background:var(--btn);border:1px solid var(--border);border-radius:10px;display:flex;align-items:center;justify-content:center;cursor:pointer;touch-action:manipulation}
  .readout{display:flex;align-items:center;justify-content:center;gap:6px;font-weight:800;font-size:20px}
  .readout input.readnum{width:clamp(48px,18vw,72px);text-align:center;background:transparent;border:none;outline:none;color:var(--text);font-weight:800;font-size:20px}
  .unit{font-weight:700;font-size:14px;opacity:.9}

  /* Bottom nav */
  .appnav{position:fixed;left:0;right:0;bottom:0;z-index:50;background:#fff;border-top:1px solid #e6ebf1;height:var(--nav-h);backdrop-filter:blur(8px)}
  .appnav .row{max-width:680px;margin:0 auto;padding:8px 12px;display:grid;grid-template-columns:repeat(5,1fr);gap:6px}
  .appnav button{appearance:none;border:none;background:transparent;color:#6b7280;display:flex;flex-direction:column;align-items:center;gap:4px;border-radius:12px;padding:6px 8px;font-weight:800;cursor:pointer}
  .appnav button .ico{width:22px;height:22px;display:block}
  .appnav button .lbl{font-size:11px}
  .appnav button.active{color:#111827;background:rgba(0,0,0,.06)}

  /* Session scoreboard */
  .board{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:6px}
  .tile{background:#0e1712;border:1px solid #233028;border-radius:12px;padding:8px;text-align:center}
  .tile .k{font-size:11px;color:#a5b0b7;letter-spacing:.06em;font-weight:700}
  .tile .v{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:22px;font-weight:900;letter-spacing:.03em;color:#d6ffb7}

  .prevrow{display:flex;align-items:center;justify-content:space-between}
  .badge{border:1px solid var(--border);background:var(--panel-2);padding:6px 8px;border-radius:8px;font-weight:800}

  /* Drill-gating */
  #page-session .only-random{display:none}
  #page-session[data-drill="random"] .only-random{display:grid}
  #page-session .only-onehand{display:none}
  #page-session[data-drill="onehand"] .only-onehand{display:block}
  #page-session .only-straight{display:none}
  #page-session[data-drill="straight"] .only-straight,
  #page-session[data-drill="onehand"]  .only-straight{display:block}

  /* Modals */
  .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;background:rgba(0,0,0,.45);z-index:100;padding:12px}
  .modal.show{display:flex}
  .modal .card{width:min(420px,92vw);background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  #depthModal{align-items:center}

  /* Split pad */
  .pad-split{display:grid;grid-template-columns:1.6fr 1fr;gap:10px;margin-top:10px}
  .pad-split > *{min-width:0}
  .lr-card{
    position:relative;border:1px solid var(--border);border-radius:16px;overflow:hidden;
    min-height:180px;background:linear-gradient(180deg,#14532d 0%, #0e3b23 55%, #052e16 100%);
    display:grid;grid-template-columns:1fr 64px 1fr;align-items:stretch;
  }
  .lr-card .half{
    appearance:none;border:none;background:transparent;color:#d6ffb7;
    font-weight:900;font-size:18px;letter-spacing:.02em;
    display:flex;align-items:center;justify-content:center;gap:8px;
    padding:14px 10px;cursor:pointer;outline-offset:3px;width:100%;touch-action:manipulation;white-space:nowrap
  }
  .lr-card .half.left{border-right:1px solid rgba(255,255,255,.08)}
  .lr-card .half.right{border-left:1px solid rgba(255,255,255,.08)}
  .midreadout{display:flex;align-items:center;justify-content:center;padding:0 6px;width:64px}
  .midreadout .num{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:22px;font-weight:900;color:#d6ffb7;letter-spacing:.02em}

  .stack{display:grid;grid-template-rows:1fr auto 1fr;gap:10px}
  .stack-btn{
    appearance:none;width:100%;border-radius:16px;border:1px solid var(--border);
    display:flex;align-items:center;justify-content:center;gap:8px;
    padding:14px 10px;font-weight:900;font-size:18px;cursor:pointer;outline-offset:3px;touch-action:manipulation
  }
  .stack-btn.long,.stack-btn.short{ background:linear-gradient(180deg, #fde68a, #f59e0b); color:#000 }

  .actions3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px}
  .btn.finish{background:linear-gradient(180deg,#fde047,#facc15);color:#111;border:none}

  .ctas{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
  .btn.cta{height:56px;padding:16px 12px;font-weight:900;font-size:16px;border-radius:14px}

  /* KPI */
  .kpi-wrap{display:flex;align-items:center;justify-content:center;font-size:32px;font-weight:900}
  .kpi-wrap .unit{margin-left:2px;font-size:18px;font-weight:900;opacity:.95}
  .kpi-wrap .dir{display:inline-flex;gap:6px;margin-left:8px;align-items:center;color:#cbd5e1}
  .kpi-wrap .dir .arr{font-size:18px;line-height:1}
  .kpi-words{font-size:12px;text-align:center;color:#9aa7b2;margin-top:2px}

  .cloud-status{margin-top:6px;padding:8px;border-radius:10px;border:1px solid var(--border);background:var(--panel-2);font-size:12px}
  .cloud-status.ok{color:#c7f9cc}
  .cloud-status.err{color:#ffd6d6}

  @media (max-width:380px){
    .stepper{grid-template-columns:32px minmax(0,1fr) 32px}
    .stepper .step{width:32px;height:32px}
    .readout input.readnum{width:clamp(42px,22vw,60px);font-size:18px}
    .lr-card{min-height:160px}
  }
</style>
</head>
<body>

<section id="page-home" class="wrap">
  <h1>⛳️ Indoor Putting</h1>
  <div class="panel">
    <p class="muted" style="margin-top:0">Focused indoor putting practice — simple tracking with sessions & stats.</p>
    <div class="row">
      <button class="btn primary" data-go="session" data-drill="straight">Straight Putt</button>
      <button class="btn primary" data-go="session" data-drill="random">Randomizer</button>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" data-go="session" data-drill="onehand">One-handed</button>
      <button class="btn" data-go="stats">Open Stats</button>
    </div>
  </div>

  <div class="panel">
    <h2>Notes</h2>
    <ul class="muted" style="margin:8px 0 0 18px;line-height:1.5">
      <li>Miss details are in <b>inches</b>; “leave” is radial inches, signed by short/long.</li>
      <li>CSV + JSON export/import. Import supports <b>Replace</b> and <b>Merge</b>.</li>
      <li>Sync across devices by signing in with the <b>same email link</b> below and tapping <b>Sync Now</b>.</li>
    </ul>
  </div>

  <div class="panel muted" style="text-align:center">© <span id="yr"></span> Indoor Putting</div>
</section>

<section id="page-session" class="wrap hidden" data-drill="straight">
  <h1 id="sessTitle">Straight Putt Drill</h1>

  <div class="panel" id="setupCard">
    <div class="grid2">
      <div class="field">
        <span class="lbl">Drill</span>
        <div class="input"><select id="drillPick">
          <option value="straight">Straight Putt</option>
          <option value="random">Randomizer</option>
          <option value="onehand">One-handed</option>
        </select></div>
      </div>
      <div class="field only-onehand" id="handField">
        <span class="lbl">Hand</span>
        <div class="input"><select id="handPick">
          <option value="right">Right</option>
          <option value="left">Left</option>
        </select></div>
      </div>
    </div>

    <div class="row" id="distStimpRow" style="margin-top:6px">
      <div class="field only-straight">
        <span class="lbl">Distance (ft)</span>
        <div class="stepper">
          <button class="step" id="sdn">−</button>
          <div class="readout"><input id="sDist" class="readnum" value="7" inputmode="decimal"/><span class="unit">ft</span></div>
          <button class="step" id="sup">＋</button>
        </div>
      </div>
      <div class="field" id="stimpField">
        <span class="lbl">Stimp</span>
        <div class="stepper">
          <button class="step" id="stimpDn">−</button>
          <div class="readout"><input id="stimp" class="readnum" value="10" inputmode="decimal"/><span class="unit">st</span></div>
          <button class="step" id="stimpUp">＋</button>
        </div>
      </div>
    </div>

    <div id="randRow" class="grid2 only-random" style="margin-top:6px">
      <div class="field">
        <span class="lbl">Min (ft)</span>
        <div class="stepper">
          <button class="step" id="rminDn">−</button>
          <div class="readout"><input id="rMin" class="readnum" value="1" inputmode="decimal"/><span class="unit">ft</span></div>
          <button class="step" id="rminUp">＋</button>
        </div>
      </div>
      <div class="field">
        <span class="lbl">Max (ft)</span>
        <div class="stepper">
          <button class="step" id="rmaxDn">−</button>
          <div class="readout"><input id="rMax" class="readnum" value="9" inputmode="decimal"/><span class="unit">ft</span></div>
          <button class="step" id="rmaxUp">＋</button>
        </div>
      </div>
    </div>
    <div id="randOpts" class="grid2 only-random">
      <div class="field">
        <span class="lbl">No back-to-back repeats</span>
        <div class="chips" id="norepeatChips">
          <div class="pill active" data-on="1">ON</div>
          <div class="pill" data-on="0">OFF</div>
        </div>
      </div>
      <div class="field">
        <span class="lbl">Current random distance</span>
        <div class="input" id="randNow">—</div>
      </div>
    </div>

    <div class="row" style="margin-top:6px;align-items:end">
      <div class="field"><span class="lbl"> </span><button class="btn success" id="beginBtn">Begin</button></div>
      <div class="field"><span class="lbl"> </span><button class="btn" data-go="home">Back</button></div>
    </div>
  </div>

  <div class="panel hidden" id="runCard">
    <div class="board">
      <div class="tile"><div class="k">HIT FROM (ft)</div><div class="v" id="boardDist">—</div></div>
      <div class="tile"><div class="k">TIME</div><div class="v" id="boardTime">00:00</div></div>
      <div class="tile"><div class="k">SCORE</div><div class="v" id="boardScore">0</div></div>
    </div>
    <div class="tile" style="margin-top:8px"><div class="k">SHOT</div><div class="v" id="boardShot">0</div></div>

    <div class="pad-split" aria-label="Action pad">
      <div class="lr-card" role="group" aria-label="Left or Right">
        <button class="half left" id="padLeft" aria-label="Left miss"><span aria-hidden="true">←</span><span>Left</span></button>
        <div class="midreadout"><span id="latRead" class="num">0″</span></div>
        <button class="half right" id="padRight" aria-label="Right miss"><span>Right</span><span aria-hidden="true">→</span></button>
      </div>
      <div class="stack" role="group" aria-label="Depth">
        <button class="stack-btn long"  id="padLong"><span aria-hidden="true">↑</span>Long</button>
        <div class="midreadout"><span id="depRead" class="num">0″</span></div>
        <button class="stack-btn short" id="padShort"><span aria-hidden="true">↓</span>Short</button>
      </div>
    </div>

    <div class="actions3">
      <button class="btn success" id="padHoled">Holed</button>
      <button class="btn primary" id="logMiss">Log Miss</button>
      <button class="btn" id="undoLast">Undo Last</button>
    </div>

    <div class="ctas">
      <button class="btn cta danger" id="padQuit">Quit</button>
      <button class="btn cta finish" id="finishSession">Finish Drill</button>
    </div>
  </div>

  <div class="panel hidden" id="logPanel">
    <h2>Log</h2>
    <table class="tight">
      <thead><tr><th>#</th><th>Date</th><th>Dist</th><th>Made</th><th>Depth (in)</th><th>Lat (in)</th><th>Leave (in)</th></tr></thead>
      <tbody id="logBody"></tbody>
    </table>
  </div>
</section>

<section id="page-stats" class="wrap hidden">
  <h1>Stats</h1>

  <div class="panel">
    <div class="grid2">
      <div class="field"><span class="lbl">Session</span><div class="input"><select id="sessionPick"><option value="">All sessions</option></select></div></div>
      <div class="field"><span class="lbl">Drill</span><div class="input"><select id="fltDrill"><option value="">All</option><option value="straight">Straight</option><option value="random">Randomizer</option><option value="onehand">One-handed</option></select></div></div>
    </div>
    <div class="grid2" style="margin-top:6px">
      <div class="field"><span class="lbl">Hand</span><div class="input"><select id="fltHand"><option value="">All</option><option value="left">Left</option><option value="right">Right</option></select></div></div>
      <div class="field"><span class="lbl">Stimp</span><div class="input"><select id="fltStimp"><option value="" selected>Any</option><option>8</option><option>9</option><option>10</option><option>11</option><option>12</option></select></div></div>
    </div>

    <!-- Cloud sign-in -->
    <div class="grid2" style="margin-top:8px">
      <div class="field">
        <span class="lbl">Email (to link devices)</span>
        <div class="input"><input id="emailBox" type="email" placeholder="you@example.com" autocomplete="email"/></div>
      </div>
      <div class="field">
        <span class="lbl">&nbsp;</span>
        <button class="btn primary" id="btnSendLink">Send Sign-in Link</button>
      </div>
    </div>

    <div id="cloudStatus" class="cloud-status">Cloud: signed out</div>

    <div class="row" style="margin-top:6px">
      <button class="btn primary" id="btnSyncNow">Sync Now (Firestore)</button>
      <button class="btn" id="btnSignOut">Sign Out</button>
    </div>

    <div class="row" style="margin-top:6px">
      <button class="btn" id="btnOpenSession" disabled>Open Session</button>
      <button class="btn danger" id="btnDeleteSession" disabled>Delete Session</button>
    </div>
  </div>

  <div class="row">
    <div class="panel"><h2 style="margin-bottom:6px">Total Putts</h2><div style="font-size:32px;font-weight:900;text-align:center" id="kpiPutts">–</div></div>
    <div class="panel">
      <h2 style="margin-bottom:6px">Avg Miss Leave (in)</h2>
      <div class="kpi-wrap" id="kpiAvgLeaveBox" aria-live="polite">
        <span class="num" id="kpiAvgLeaveNum">–</span><span class="unit">″</span>
        <span class="dir" id="kpiAvgLeaveDir"></span>
      </div>
      <div class="kpi-words" id="kpiAvgLeaveWords"></div>
    </div>
  </div>

  <div class="panel">
    <h2>Distance Buckets (by starting distance)</h2>
    <table class="tight">
      <thead><tr><th>Bucket (ft)</th><th class="right"># of Putts</th><th class="right">Longest Streak</th><th class="right">Make%</th></tr></thead>
      <tbody id="bucketRows"></tbody>
    </table>
    <p class="muted" id="bucketNote" style="margin-top:6px">Buckets use the putt’s starting distance. “10+” appears automatically when you log &gt;10 ft.</p>
  </div>

  <div class="panel hidden" id="sessionDetailsPanel">
    <h2 id="sdTitle">Session Details</h2>
    <div id="sdMeta" class="muted" style="margin-top:6px"></div>
    <table class="tight" style="margin-top:8px">
      <thead><tr><th>#</th><th>Time</th><th>Dist</th><th>Made</th><th>Depth (in)</th><th>Lat (in)</th><th>Leave (in)</th></tr></thead>
      <tbody id="sdBody"></tbody>
    </table>
  </div>
</section>

<nav class="appnav" id="appnav" aria-label="App navigation">
  <div class="row">
    <button data-nav="#/home"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M12 3l9 8h-3v9h-5v-6h-2v6H6v-9H3z"/></svg><span class="lbl">Home</span></button>
    <button data-nav="#/session"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25z"/></svg><span class="lbl">Session</span></button>
    <button data-nav="#/new"><svg class="ico" viewBox="0 0 24 24" fill="none"><path d="M12 5v14M5 12h14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg><span class="lbl">New</span></button>
    <button data-nav="#/stats"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M5 9h3v10H5zM10.5 5H14v14h-3.5zM16 12h3v7h-3z"/></svg><span class="lbl">Stats</span></button>
    <button data-nav="#/more"><svg class="ico" viewBox="0 0 24 24" fill="currentColor"><path d="M6 12a2 2 0 114 0 2 2 0 01-4 0zm4 0a2 2 0 114 0 2 2 0 01-4 0zm4 0a2 2 0 114 0 2 2 0 01-4 0z"/></svg><span class="lbl">More</span></button>
  </div>
</nav>

<div id="depthModal" class="modal" aria-hidden="true">
  <div class="card">
    <h2 style="margin-bottom:6px">How much?</h2>
    <div class="stepper">
      <button class="step" id="depDn">−</button>
      <div class="readout"><input id="depthAmount" class="readnum" value="0.5" inputmode="decimal"/><span class="unit">ft</span></div>
      <button class="step" id="depUp">＋</button>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="depCancel">Cancel</button>
      <button class="btn success" id="depSave">Save</button>
    </div>
  </div>
</div>

<div id="moreSheet" class="modal" aria-hidden="true">
  <div class="card" style="max-width:420px">
    <div class="row">
      <button id="msExportSession">Export CSV (Session)</button>
      <button id="msExportStats">Export CSV (Stats)</button>
      <button id="msExportJSON">Export JSON</button>
      <button id="msImportJSON">Import JSON (Replace)</button>
      <button id="msImportJSONMerge">Import JSON (Merge)</button>
      <button id="msSyncNow">Sync Now (Firestore)</button>
      <button id="msClose">Close</button>
    </div>
  </div>
</div>
<input type="file" id="importJSONInput" accept="application/json" hidden/>

<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInAnonymously, signOut,
  isSignInWithEmailLink, sendSignInLinkToEmail, signInWithEmailLink,
  EmailAuthProvider, linkWithCredential
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import {
  getFirestore, doc, setDoc, getDocs, collection, writeBatch
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBesf0Vh0Omn5sWKlA7hkPtzPBe6rk1e88",
  authDomain: "indoor-putting-app.firebaseapp.com",
  projectId: "indoor-putting-app",
  storageBucket: "indoor-putting-app.firebasestorage.app",
  messagingSenderId: "290656078722",
  appId: "1:290656078722:web:f447b38cc90c560d539d9b",
  measurementId: "G-LGKFTPPENE"
};

const fbApp = initializeApp(firebaseConfig);
const auth  = getAuth(fbApp);
const db    = getFirestore(fbApp);

/* ---------- Helpers & DOM ---------- */
const pad2=n=>String(n).padStart(2,'0');
const fmtDate=d=>`${pad2(d.getMonth()+1)}-${pad2(d.getDate())}-${d.getFullYear()}`;
const fmtDot=d=>`${pad2(d.getMonth()+1)}.${pad2(d.getDate())}.${d.getFullYear()}`;
const fmtTime=d=>`${pad2(d.getHours())}:${pad2(d.getMinutes())}`;
const fmtDur=s=>{const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), ss=s%60; return h?`${h}:${pad2(m)}:${pad2(ss)}`:`${m}:${pad2(ss)}`;};
const r05=v=>Math.round((Number(v)||0)*2)/2;
const nowISO=()=>new Date().toISOString();
const $=q=>document.querySelector(q); const $all=q=>Array.from(document.querySelectorAll(q));
document.getElementById('yr').textContent=(new Date()).getFullYear();

/* ---------- Router ---------- */
const PAGES={home:$('#page-home'), session:$('#page-session'), stats:$('#page-stats')};
function show(hash){
  const route=(hash||'#/home').split('?')[0];
  Object.values(PAGES).forEach(el=>el.classList.add('hidden'));
  if(route==="#/session"){ PAGES.session.classList.remove('hidden'); ensureSetupVisibility(); }
  else if(route==="#/stats"){ PAGES.stats.classList.remove('hidden'); initStats(); }
  else PAGES.home.classList.remove('hidden');
  setActiveNav(route);
}
function setActiveNav(route){$all('#appnav [data-nav]').forEach(b=> b.classList.toggle('active', b.dataset.nav===route));}
window.addEventListener('hashchange', ()=> show(location.hash));
$('#appnav').addEventListener('click',(e)=>{
  const b=e.target.closest('button[data-nav]'); if(!b) return;
  if(b.dataset.nav==="#/more"){toggleSheet(true);return;}
  if(b.dataset.nav==="#/new"){ location.hash='#/session'; return; }
  location.hash=b.dataset.nav;
});
$all('[data-go="session"]').forEach(btn=>{
  btn.onclick=()=>{location.hash=`#/session?drill=${encodeURIComponent(btn.dataset.drill||'straight')}`;}
});
$all('[data-go="stats"]').forEach(b=> b.onclick=()=> location.hash='#/stats');
$all('[data-go="home"]').forEach(b=> b.onclick=()=> location.hash='#/home');
show(location.hash||'#/home');

/* ---------- IndexedDB ---------- */
const DB='indoor_putting';
function openDB(){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(DB);
    req.onupgradeneeded=()=>{
      const db=req.result;
      if(!db.objectStoreNames.contains('sessions')) db.createObjectStore('sessions',{keyPath:'id'});
      if(!db.objectStoreNames.contains('putts')){
        const st=db.createObjectStore('putts',{keyPath:'uid',autoIncrement:true});
        st.createIndex('by_session','sessionId',{unique:false});
      }
    };
    req.onsuccess=()=>res(req.result); req.onerror=()=>rej(req.error);
  });
}
function idbAdd(store,val){return new Promise((res,rej)=>{const r=store.add(val); r.onsuccess=()=>res(r.result); r.onerror=()=>rej(r.error);});}
async function idbAll(name){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(name,'readonly'); const st=tx.objectStore(name); const out=[];
    st.openCursor().onsuccess=e=>{const c=e.target.result; if(c){out.push(c.value); c.continue();} else{db.close(); res(out);} };
    tx.onerror=()=>rej(tx.error);
  });
}
async function idbGetPuttsBySession(sessionId){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction('putts','readonly'); const idx=tx.objectStore('putts').index('by_session');
    const out=[]; idx.openCursor(IDBKeyRange.only(sessionId)).onsuccess=e=>{
      const c=e.target.result; if(c){out.push(c.value); c.continue();} else { db.close(); res(out); }
    };
    tx.onerror=()=>rej(tx.error);
  });
}
async function idbDeleteSessionCascade(sessionId){
  const db=await openDB();
  return new Promise((res,rej)=>{
    const tx=db.transaction(['sessions','putts'],'readwrite');
    tx.objectStore('sessions').delete(sessionId);
    const idx=tx.objectStore('putts').index('by_session');
    idx.openCursor(IDBKeyRange.only(sessionId)).onsuccess=e=>{const c=e.target.result; if(c){c.delete(); c.continue();}};
    tx.oncomplete=()=>{db.close();res();}; tx.onerror=()=>rej(tx.error||new Error('delete failed'));
  });
}
function deleteWholeDB(){return new Promise((res,rej)=>{const r=indexedDB.deleteDatabase(DB); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error); r.onblocked=()=>alert('Close other tabs to finish importing.');});}

/* ---------- Session UI ---------- */
const pageSession = $('#page-session');
const ui={
  drillPick:$('#drillPick'), handPick:$('#handPick'),
  sdn:$('#sdn'), sup:$('#sup'), sDist:$('#sDist'),
  rminDn:$('#rminDn'), rminUp:$('#rminUp'), rMin:$('#rMin'),
  rmaxDn:$('#rmaxDn'), rmaxUp:$('#rmaxUp'), rMax:$('#rMax'),
  stimpDn:$('#stimpDn'), stimpUp:$('#stimpUp'), stimp:$('#stimp'),
  randNow:$('#randNow'),
  beginBtn:$('#beginBtn'),
  setupCard:$('#setupCard'), runCard:$('#runCard'), logPanel:$('#logPanel'),
  boardDist:$('#boardDist'), boardTime:$('#boardTime'), boardScore:$('#boardScore'), boardShot:$('#boardShot'),
  padLeft:$('#padLeft'), padRight:$('#padRight'), padHoled:$('#padHoled'), padLong:$('#padLong'), padShort:$('#padShort'),
  logMiss:$('#logMiss'), undoLast:$('#undoLast'), finishSession:$('#finishSession'),
  logBody:$('#logBody'), sessTitle:$('#sessTitle'),
  latRead:$('#latRead'), depRead:$('#depRead'),
};
const stepInput=(input,delta,min,max)=>{ input.value=String(r05(Math.max(min,Math.min(max,(Number(input.value)||0)+delta)))); };
ui.sdn.onclick = ()=> stepInput(ui.sDist,-0.5,1,30);
ui.sup.onclick = ()=> stepInput(ui.sDist,+0.5,1,30);
ui.rminDn.onclick = ()=> stepInput(ui.rMin,-0.5,1,30);
ui.rminUp.onclick = ()=> stepInput(ui.rMin,+0.5,1,30);
ui.rmaxDn.onclick = ()=> stepInput(ui.rMax,-0.5,1,30);
ui.rmaxUp.onclick = ()=> stepInput(ui.rMax,+0.5,1,30);
ui.stimpDn.onclick = ()=> stepInput(ui.stimp,-0.5,6,16);
ui.stimpUp.onclick = ()=> stepInput(ui.stimp,+0.5,6,16);

function ensureSetupVisibility(){
  const d=ui.drillPick.value;
  pageSession.setAttribute('data-drill', d);
  $('#sessTitle').textContent = d==='straight' ? 'Straight Putt Drill' : d==='random' ? 'Randomizer Drill' : 'One-handed Drill';
  if(d!=='random') ui.randNow.textContent='—';
}
ui.drillPick.addEventListener('change', ensureSetupVisibility);

/* Random distance */
let lastRand=null;
function genRandomDist(){
  const min=r05(Math.max(1,Math.min(30,Number($('#rMin').value)||1)));
  const max=r05(Math.max(1,Math.min(30,Number($('#rMax').value)||9)));
  const norepeat=true;
  const steps=Math.round((max-min)*2)+1; if(steps<=0) return min;
  let cand=min;
  for(let i=0;i<50;i++){
    const k=Math.floor(Math.random()*steps); cand=r05(min+k*0.5); if(cand!==lastRand) break;
  }
  return cand;
}

/* Run state */
let sess=null; let log=[]; let latIn=0, depIn=0;
let timerI=null; let timerStart=0;
function updateReadouts(){ $('#latRead').textContent=(latIn>0?'+':'')+latIn+'″'; $('#depRead').textContent=(depIn>0?'+':'')+depIn+'″'; }
function startTimer(){ timerStart=Date.now(); stopTimer(); timerI=setInterval(()=>{const s=Math.floor((Date.now()-timerStart)/1000); $('#boardTime').textContent=`${pad2(Math.floor(s/60))}:${pad2(s%60)}`;},250); }
function stopTimer(){ if(timerI){clearInterval(timerI); timerI=null;} }

function begin(){
  ensureSetupVisibility();
  const drill=$('#drillPick').value;
  const hand = drill==='onehand' ? $('#handPick').value : '';
  const stimp= Number($('#stimp').value)||10;
  sess={ id:`s_${Date.now()}`, drill, hand, stimp, started_at: nowISO() };
  log=[]; lastRand=null; latIn=0; depIn=0; updateReadouts();
  let dist=(drill==='random')? genRandomDist() : r05(Math.max(1,Math.min(30,Number($('#sDist').value)||7)));
  if(drill==='random'){ lastRand=dist; $('#randNow').textContent=`${dist} ft`; }
  setBoard(dist,0,0);
  $('#setupCard').classList.add('hidden'); $('#runCard').classList.remove('hidden'); $('#logPanel').classList.remove('hidden');
  startTimer(); renderLog();
}
function setBoard(dist,score,shot){ $('#boardDist').textContent=dist?dist.toFixed(1):'—'; $('#boardScore').textContent=String(score); $('#boardShot').textContent=String(shot); }
$('#beginBtn').onclick=begin;

function saveAttempt(o){
  if(!sess) return;
  const dist = Number($('#boardDist').textContent)||0;
  const depth_in = (o.depth_in!=null)?Number(o.depth_in):(o.depth_ft!=null?Number(o.depth_ft)*12:0);
  const lat_in   = (o.lat_in!=null)?Number(o.lat_in):0;
  const depth_ft = (o.depth_ft!=null)?Number(o.depth_ft):(depth_in/12);
  const lateral  = o.lateral || (lat_in<0?'L':lat_in>0?'R':'C');
  const derived_in = Math.round(Math.hypot(depth_in,lat_in));
  const leave_signed_in = depth_in<0 ? -derived_in : derived_in;
  const row={sessionId:sess.id, ts:nowISO(), distance_ft:dist, made:!!o.made,
             depth_ft, depth_in:Math.round(depth_in), lateral, lat_in:Math.round(lat_in),
             leave_in:leave_signed_in, leave_ft:Math.abs(derived_in)/12,
             drill:sess.drill, hand:sess.hand, stimp:sess.stimp};
  log.push(row);
  const score=log.filter(r=>r.made).length; setBoard(dist,score,log.length);
  nextTarget(); renderLog();
}
function nextTarget(){
  if(!sess) return;
  let dist;
  if(sess.drill==='random'){ dist=genRandomDist(); lastRand=dist; $('#randNow').textContent=`${dist} ft`; }
  else { dist=r05(Math.max(1,Math.min(30,Number($('#sDist').value)||7))); }
  $('#boardDist').textContent=dist.toFixed(1);
  latIn=0; depIn=0; updateReadouts();
}

$('#padLeft').onclick = ()=>{ latIn=Math.max(-200,latIn-1); updateReadouts(); };
$('#padRight').onclick= ()=>{ latIn=Math.min( 200,latIn+1); updateReadouts(); };
$('#padLong').onclick = ()=>{ depIn=Math.min( 600,depIn+1); updateReadouts(); };
$('#padShort').onclick= ()=>{ depIn=Math.max(-600,depIn-1); updateReadouts(); };

$('#logMiss').onclick= ()=>{ if(latIn===0 && depIn===0 && !confirm('No inches set (0 / 0). Log as center miss?')) return; saveAttempt({made:false, depth_in:depIn, lat_in:latIn}); };
$('#padHoled').onclick= ()=> saveAttempt({made:true, depth_in:0, lat_in:0});

$('#undoLast').onclick= ()=>{
  if(!log.length) return;
  log.pop();
  const score=log.filter(r=>r.made).length;
  setBoard(Number($('#boardDist').textContent)||0,score,log.length);
  renderLog();
};

$('#padQuit').onclick = ()=>{ if(confirm('Quit this drill without saving?')) resetSession(); };
$('#finishSession').onclick = saveSession;

function resetSession(){
  if(timerI){clearInterval(timerI); timerI=null;}
  sess=null; log=[]; lastRand=null; latIn=0; depIn=0; updateReadouts();
  $('#runCard').classList.add('hidden'); $('#logPanel').classList.add('hidden'); $('#setupCard').classList.remove('hidden');
  ensureSetupVisibility(); renderLog();
}

function renderLog(){
  const tb=$('#logBody'); tb.innerHTML='';
  log.forEach((r,i)=>{
    const d=new Date(r.ts);
    const depthIn=('depth_in' in r)?r.depth_in:Math.round((r.depth_ft||0)*12);
    const latIn  =('lat_in' in r)?r.lat_in:(r.lateral==='L'?-1:(r.lateral==='R'?1:0));
    const leaveIn=(typeof r.leave_in==='number')?r.leave_in:((()=>{const m=Math.round(Math.hypot(depthIn,latIn)); return depthIn<0?-m:m;})());
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${fmtDate(d)}</td><td>${r.distance_ft.toFixed(1)} ft</td><td>${r.made?'Yes':'No'}</td><td>${depthIn}"</td><td>${latIn}"</td><td>${leaveIn}"</td>`;
    tb.appendChild(tr);
  });
}

async function saveSession(){
  if(!sess || !log.length){ alert('No attempts logged yet.'); return; }
  const bestByDist={}, curByDist={};
  if(sess.drill!=='random'){
    for(const r of log){
      const k=(Math.round(r.distance_ft*2)/2).toFixed(1);
      if(r.made){ curByDist[k]=(curByDist[k]||0)+1; bestByDist[k]=Math.max(bestByDist[k]||0, curByDist[k]); }
      else curByDist[k]=0;
    }
  }
  try{
    const existing=await idbAll('sessions');
    const dayKey=(sess.started_at||nowISO()).slice(0,10);
    const todays=existing.filter(s=>(s.started_at||'').slice(0,10)===dayKey);
    const maxSeq=todays.reduce((m,s)=>Math.max(m,Number(s.daySeq||0)),0);
    const nextSeq=maxSeq>0?(maxSeq+1):(todays.length+1);

    const dbi=await openDB();
    const tx=dbi.transaction(['sessions','putts'],'readwrite');
    const stS=tx.objectStore('sessions'); const stP=tx.objectStore('putts');

    const sid=sess.id;
    await new Promise((res,rej)=>{const r=stS.add({id:sid, drill:sess.drill, hand:sess.hand, stimp:sess.stimp, started_at:sess.started_at, ended_at:nowISO(), bestByDist, daySeq:nextSeq}); r.onsuccess=()=>res(); r.onerror=()=>rej(r.error);});
    for(const row of log) await idbAdd(stP,row);

    await new Promise((res,rej)=>{tx.oncomplete=()=>{dbi.close();res();}; tx.onerror=()=>rej(tx.error||new Error('TX failed'));});
    localStorage.setItem('lastSid',sid);
    alert('Session saved.');
    resetSession(); location.hash='#/stats';
  }catch(e){ console.error(e); alert('Could not save session.'); }
}

/* ---------- Stats & buckets ---------- */
const stats={
  sessionPick:$('#sessionPick'), fltDrill:$('#fltDrill'), fltHand:$('#fltHand'), fltStimp:$('#fltStimp'),
  kpiPutts:$('#kpiPutts'),
  kpiAvgBox:$('#kpiAvgLeaveBox'), kpiAvgNum:$('#kpiAvgLeaveNum'), kpiAvgDir:$('#kpiAvgLeaveDir'), kpiAvgWords:$('#kpiAvgLeaveWords'),
  bucketRows:$('#bucketRows'),
  btnOpen:$('#btnOpenSession'), btnDelete:$('#btnDeleteSession'),
  sdPanel:$('#sessionDetailsPanel'), sdTitle:$('#sdTitle'), sdMeta:$('#sdMeta'), sdBody:$('#sdBody'),
  emailBox:$('#emailBox'), btnSendLink:$('#btnSendLink'),
  cloudStatus:$('#cloudStatus'), btnSyncNow:$('#btnSyncNow'), btnSignOut:$('#btnSignOut')
};
let SESS=[], PUTTS=[];
function signedDepthIn(r){ if(typeof r.depth_in==='number') return r.depth_in; if(typeof r.depth_ft==='number') return Math.round(r.depth_ft*12); return 0; }
function signedLatIn(r){ if(typeof r.lat_in==='number') return r.lat_in; if(r.lateral==='L') return -1; if(r.lateral==='R') return 1; return 0; }
function derivedLeaveSignedIn(r){ if(typeof r.leave_in==='number') return r.leave_in; const di=signedDepthIn(r), li=signedLatIn(r); const m=Math.round(Math.hypot(di,li)); return di<0?-m:m; }
function derivedLeaveAbsIn(r){ return Math.abs(derivedLeaveSignedIn(r)); }

async function initStats(){
  [SESS,PUTTS]=await Promise.all([idbAll('sessions'), idbAll('putts')]);
  populateSessions(); renderStats(); updateActionButtons();
  const lastSid=localStorage.getItem('lastSid');
  if(lastSid && Array.from(stats.sessionPick.options).some(o=>o.value===lastSid)){
    stats.sessionPick.value=lastSid; renderStats(); renderSessionDetails(true); updateActionButtons();
  }
}
function populateSessions(){
  const sel=stats.sessionPick; const prev=sel.value; sel.innerHTML='<option value="">All sessions</option>';
  const byDay={}; SESS.forEach(s=>{const d=(s.started_at||'').slice(0,10); (byDay[d]||(byDay[d]=[])).push(s);});
  Object.keys(byDay).sort().forEach(dkey=>{
    const list=byDay[dkey].sort((a,b)=> (a.daySeq&&b.daySeq)?(a.daySeq-b.daySeq):((a.started_at||'').localeCompare(b.started_at||'')));
    list.forEach(s=>{
      const d=new Date(s.started_at||dkey); const n=Number(s.daySeq||1);
      const label=`${fmtDot(d)} (${n})`;
      const opt=document.createElement('option'); opt.value=s.id; opt.textContent=label; opt.dataset.label=label;
      if(prev && prev===s.id) opt.selected=true; sel.appendChild(opt);
    });
  });
}
const filters=()=>({sid:stats.sessionPick.value||'', drill:stats.fltDrill.value||'', hand:stats.fltHand.value||'', stimp:stats.fltStimp.value||''});
function applyFilters(rows){
  const f=filters();
  return rows.filter(r=>
    (!f.sid   || r.sessionId===f.sid) &&
    (!f.drill || r.drill===f.drill) &&
    (!f.hand  || r.hand===f.hand) &&
    (!f.stimp || String(r.stimp)===String(f.stimp))
  );
}
function bucket(ft){ const d=Number(ft)||0; if(d<=2)return'1–2'; if(d<=4)return'3–4'; if(d<=6)return'5–6'; if(d<=8)return'7–8'; if(d<=10)return'9–10'; return'10+'; }
function longestStreakFor(rows){ let best=0,cur=0; rows.forEach(r=>{ if(r.made){cur++;best=Math.max(best,cur);} else cur=0;}); return best; }
function renderStats(){
  const rows=applyFilters(PUTTS);
  const miss=rows.filter(r=>!r.made);
  if(miss.length){
    const avgAbs = miss.reduce((s,r)=>s+derivedLeaveAbsIn(r),0)/miss.length;
    const avgDepth=miss.reduce((s,r)=>s+signedDepthIn(r),0)/miss.length;
    const avgLat  =miss.reduce((s,r)=>s+signedLatIn(r),0)/miss.length;
    const num=(Math.round(avgAbs*10)/10).toFixed(1); stats.kpiAvgNum.textContent=num;
    const th=0.25; const depthArrow=Math.abs(avgDepth)<th?'•':(avgDepth>0?'↑':'↓'); const latArrow=Math.abs(avgLat)<th?'•':(avgLat>0?'→':'←');
    stats.kpiAvgDir.innerHTML=`<span class="arr">${depthArrow}</span><span class="arr">${latArrow}</span>`;
    const depthWord=Math.abs(avgDepth)<th?'center':(avgDepth>0?'long':'short'); const latWord=Math.abs(avgLat)<th?'center':(avgLat>0?'right':'left');
    const parts=[]; if(depthWord!=='center') parts.push(depthWord); if(latWord!=='center') parts.push(latWord);
    $('#kpiAvgLeaveWords').textContent=parts.length?parts.join(' and '):'center';
  }else{ stats.kpiAvgNum.textContent='–'; stats.kpiAvgDir.textContent=''; $('#kpiAvgLeaveWords').textContent=''; }
  stats.kpiPutts.textContent=String(rows.length||0);
  const base=['1–2','3–4','5–6','7–8','9–10']; const include10plus=rows.some(r=>r.distance_ft>10); const order=include10plus?base.concat(['10+']):base;
  const sorted=rows.slice().sort((a,b)=> (a.ts||'').localeCompare(b.ts||'')); const groups={}; order.forEach(k=>groups[k]=[]);
  sorted.forEach(r=>{ (groups[bucket(r.distance_ft)]||(groups[bucket(r.distance_ft)]=[])).push(r);});
  $('#bucketRows').innerHTML=''; order.forEach(k=>{
    const g=groups[k]||[]; const n=g.length; const makes=g.reduce((m,r)=>m+(r.made?1:0),0); const mk=n?(makes/n*100):0; const longest=longestStreakFor(g);
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${k}</td><td class="right">${n}</td><td class="right">${n?longest:'—'}</td><td class="right">${n?mk.toFixed(0)+'%':'—'}</td>`; $('#bucketRows').appendChild(tr);
  });
  if(!filters().sid){ $('#sessionDetailsPanel').classList.add('hidden'); }
}
async function renderSessionDetails(scroll=false){
  const sid=filters().sid; if(!sid){ $('#sessionDetailsPanel').classList.add('hidden'); return; }
  const session = SESS.find(s=>s.id===sid);
  const label = stats.sessionPick.selectedOptions[0]?.dataset.label || 'Session';
  const rows = (await idbGetPuttsBySession(sid)).sort((a,b)=> (a.ts||'').localeCompare(b.ts||''));
  const attempts=rows.length; const makes=rows.filter(r=>r.made).length; const makePct=attempts?((makes/attempts)*100).toFixed(1):'0.0';
  const miss=rows.filter(r=>!r.made); const avgMissIn=miss.length? (Math.round((miss.reduce((s,r)=>s+derivedLeaveAbsIn(r),0)/miss.length)*10)/10).toFixed(1) : '0.0';
  const startTs=session?.started_at||rows[0]?.ts; const endTs=session?.ended_at||rows[rows.length-1]?.ts||startTs; let dur='—';
  if(startTs&&endTs){ const secs=Math.max(0,Math.floor((new Date(endTs)-new Date(startTs))/1000)); dur=fmtDur(secs); }
  const drill=session?.drill||rows[0]?.drill||''; const hand=session?.hand||rows[0]?.hand||''; const stimp=session?.stimp||rows[0]?.stimp||'';
  $('#sdTitle').textContent=label;
  $('#sdMeta').textContent=`Drill: ${drill||'—'}${hand?` • Hand: ${hand}`:''}${stimp?` • Stimp: ${stimp}`:''} • Time: ${dur} • Attempts: ${attempts} • Makes: ${makes} (${makePct}%) • Avg miss leave: ${miss.length?avgMissIn:'—'}″`;
  $('#sdBody').innerHTML='';
  rows.forEach((r,i)=>{
    const d=new Date(r.ts); const depthIn=('depth_in' in r)?r.depth_in:Math.round((r.depth_ft||0)*12);
    const latIn=('lat_in' in r)?r.lat_in:(r.lateral==='L'?-1:(r.lateral==='R'?1:0)); const leaveIn=derivedLeaveSignedIn(r);
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${i+1}</td><td>${fmtTime(d)}</td><td>${(r.distance_ft||0).toFixed(1)} ft</td><td>${r.made?'Yes':'No'}</td><td>${depthIn}"</td><td>${latIn}"</td><td>${leaveIn}"</td>`; $('#sdBody').appendChild(tr);
  });
  $('#sessionDetailsPanel').classList.remove('hidden'); if(scroll) $('#sessionDetailsPanel').scrollIntoView({behavior:'smooth',block:'start'});
}
function updateActionButtons(){ const sid=filters().sid; $('#btnOpenSession').disabled=!sid; $('#btnDeleteSession').disabled=!sid; }
stats.sessionPick.onchange=()=>{ renderStats(); renderSessionDetails(); updateActionButtons(); };
stats.fltDrill.onchange=()=>renderStats(); stats.fltHand.onchange=()=>renderStats(); stats.fltStimp.onchange=()=>renderStats();
$('#btnOpenSession').onclick=()=>renderSessionDetails(true);
$('#btnDeleteSession').onclick=async ()=>{
  const sid=filters().sid; if(!sid) return;
  if(!confirm('Delete this session and all its putts? This cannot be undone.')) return;
  try{ await idbDeleteSessionCascade(sid); if(localStorage.getItem('lastSid')===sid) localStorage.removeItem('lastSid');
    alert('Session deleted.'); await initStats(); stats.sessionPick.value=''; renderStats(); renderSessionDetails(); updateActionButtons();
  }catch(err){ console.error(err); alert('Delete failed.'); }
};

/* ---------- More / CSV / JSON ---------- */
function toggleSheet(on){ $('#moreSheet').classList.toggle('show', !!on); }
$('#msClose').onclick=()=>toggleSheet(false);
const sanitizeCsvCell=(cell)=>{let s=String(cell??"").replace(/\r/g,"").replace(/\n/g," ");const t=s.trim();const isNum=/^-?\d+(\.\d+)?$/.test(t);if(!isNum&&/^[=+\-@]/.test(t))s="'"+s;if(/[",]/.test(s))s='"'+s.replace(/"/g,'""')+'"';return s;};
const download=(filename,blob)=>{const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=filename;a.rel='noopener';a.click();setTimeout(()=>URL.revokeObjectURL(url),1500);};
$('#msExportSession').onclick=async ()=>{
  const sid=$('#sessionPick').value; if(!sid){ alert('Pick a session in the Stats filter first.'); return; }
  const rows=await idbGetPuttsBySession(sid);
  const cols=['session_id','date','drill','hand','stimp','distance_ft','made','depth_in','lat_in','leave_in']; const out=[cols];
  rows.forEach(r=>{
    const d=new Date(r.ts);
    const depthIn=(typeof r.depth_in==='number')?r.depth_in:Math.round((r.depth_ft||0)*12);
    const latIn  =(typeof r.lat_in==='number')?r.lat_in:(r.lateral==='L'?-1:(r.lateral==='R'?1:0));
    const leaveIn=(typeof r.leave_in==='number')?r.leave_in:((()=>{const m=Math.round(Math.hypot(depthIn,latIn)); return depthIn<0?-m:m;})());
    out.push([r.sessionId, `${d.toISOString().slice(0,10)}`, r.drill||'', r.hand||'', r.stimp||'', r.distance_ft, r.made?1:0, depthIn, latIn, leaveIn]);
  });
  const csv=out.map(row=>row.map(sanitizeCsvCell).join(',')).join('\n');
  download('indoor_putting_session.csv', new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'}));
  toggleSheet(false);
};
$('#msExportStats').onclick=async ()=>{
  const selRows=applyFilters(PUTTS); const byD=new Map();
  selRows.forEach(r=>{
    const key=(Math.round((Number(r.distance_ft)||0)*2)/2).toFixed(1);
    const e=byD.get(key)||{attempts:0,made:0,misses:0,missLeaveInSum:0}; e.attempts++; if(r.made){e.made++;} else {e.misses++; e.missLeaveInSum += derivedLeaveAbsIn(r);} byD.set(key,e);
  });
  const out=[['distance_ft','attempts','made','make_pct','avg_miss_leave_in']];
  Array.from(byD.keys()).sort((a,b)=>parseFloat(a)-parseFloat(b)).forEach(k=>{
    const e=byD.get(k); const mk=e.attempts?(e.made/e.attempts*100):0; const avgIn=e.misses?(e.missLeaveInSum/e.misses):0;
    out.push([k,e.attempts,e.made,mk.toFixed(1),(Math.round(avgIn*10)/10).toFixed(1)]);
  });
  const csv=out.map(r=>r.map(sanitizeCsvCell).join(',')).join('\n'); download('indoor_putting_stats.csv', new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'})); toggleSheet(false);
};
$('#msExportJSON').onclick=async ()=>{
  const sessions=await idbAll('sessions'), putts=await idbAll('putts');
  const data={schema:'indoor_putting',version:1,exportedAt:nowISO(),sessions,putts};
  download(`IndoorPutting_${(new Date()).toISOString().slice(0,10)}.json`, new Blob([JSON.stringify(data,null,2)],{type:'application/json'}));
  toggleSheet(false);
};
$('#msImportJSON').onclick=()=>{ $('#importJSONInput').click(); $('#importJSONInput').dataset.mode='replace'; toggleSheet(false); };
$('#msImportJSONMerge').onclick=()=>{ $('#importJSONInput').click(); $('#importJSONInput').dataset.mode='merge'; toggleSheet(false); };
$('#importJSONInput').addEventListener('change', async (e)=>{
  const file=e.target.files && e.target.files[0]; e.target.value=''; if(!file) return;
  const mode=e.target.dataset.mode||'replace';
  try{
    const text=await file.text(); const data=JSON.parse(text);
    if(!data || data.schema!=='indoor_putting'){ alert('Invalid JSON schema.'); return; }
    if(mode==='replace'){
      await deleteWholeDB(); await openDB();
      const db=await openDB(); const tx=db.transaction(['sessions','putts'],'readwrite'); const stS=tx.objectStore('sessions'); const stP=tx.objectStore('putts');
      for(const s of (data.sessions||[])) stS.add(s); for(const p of (data.putts||[])) stP.add(p);
      await new Promise((res,rej)=>{tx.oncomplete=()=>{db.close();res();}; tx.onerror=()=>rej(tx.error||new Error('import failed'));});
      alert('Import complete (data replaced).');
    }else{
      const db=await openDB();
      await new Promise((res,rej)=>{
        const tx=db.transaction(['sessions','putts'],'readwrite'); const stS=tx.objectStore('sessions'); const stP=tx.objectStore('putts');
        const puttKeys=new Set(); const t2=db.transaction('putts','readonly').objectStore('putts').openCursor();
        t2.onsuccess=(ev)=>{const c=ev.target.result; if(c){puttKeys.add((c.value.sessionId||'')+'|'+(c.value.ts||'')); c.continue();}};
        t2.oncomplete=()=>{
          (data.sessions||[]).forEach(s=>stS.put(s));
          (data.putts||[]).forEach(p=>{const key=(p.sessionId||'')+'|'+(p.ts||''); if(!puttKeys.has(key)) stP.add(p);});
        };
        tx.oncomplete=()=>{db.close();res();}; tx.onerror=()=>rej(tx.error||new Error('merge failed'));
      });
      alert('Import complete (merged).');
    }
    initStats(); location.hash='#/stats';
  }catch(err){ console.error(err); alert('Import failed.'); }
});
document.addEventListener('click',(ev)=>{ const s=$('#moreSheet'); if(s.classList.contains('show') && !ev.target.closest('#moreSheet .card') && !ev.target.closest('[data-nav="#/more"]')) toggleSheet(false); });

/* ---------- Haptics (light) ---------- */
function haptic(kind='neutral'){ try{ if(!('vibrate' in navigator)) return; const p={neutral:[12],success:[12,40,12],warn:[8,30,8],danger:[30,60,30]}; navigator.vibrate(p[kind]||p.neutral);}catch(_){ } }
['padLeft','padRight','padLong','padShort','padHoled','logMiss','finishSession','btnSyncNow','msSyncNow'].forEach(id=>{
  const el=document.getElementById(id); if(el) el.addEventListener('pointerdown', ()=>haptic('neutral'), {passive:true});
});

/* ---------- Auth: Email-link upgrade (cross-device) ---------- */
let currentUID=null;
function setCloudStatus(text, ok=false){ stats.cloudStatus.textContent=text; stats.cloudStatus.classList.toggle('ok',!!ok); stats.cloudStatus.classList.toggle('err',!ok); }
function currentReturnUrl(){ return window.location.origin + window.location.pathname + (location.hash?location.hash:''); }

onAuthStateChanged(auth, (user)=>{
  if(user){
    currentUID=user.uid;
    const who = user.isAnonymous ? '(anonymous)' : (user.email || user.uid.slice(0,6)+'…');
    setCloudStatus(`Cloud: signed in as ${who}`, !user.isAnonymous);
  }else{
    currentUID=null;
    setCloudStatus('Cloud: signed out', false);
  }
});

/* initial anonymous — lets you log before upgrading */
signInAnonymously(auth).catch(err=>setCloudStatus(`Cloud: sign-in error — ${err.code||err.message}`, false));

/* Handle coming back from email link */
(async function handleEmailLinkIfNeeded(){
  if(isSignInWithEmailLink(auth, window.location.href)){
    try{
      let email = window.localStorage.getItem('emailForSignIn') || prompt('Confirm your email to finish sign-in:');
      if(!email){ alert('Email required.'); return; }
      const cred = EmailAuthProvider.credentialWithLink(email, window.location.href);
      if(auth.currentUser && auth.currentUser.isAnonymous){
        await linkWithCredential(auth.currentUser, cred); // upgrade (keeps UID)
      }else{
        await signInWithEmailLink(auth, email, window.location.href); // normal sign-in
      }
      window.localStorage.removeItem('emailForSignIn');
      // Clean the URL
      window.history.replaceState({}, document.title, window.location.pathname + (location.hash?location.hash:''));
      setCloudStatus('Cloud: signed in (email link)', true);
    }catch(err){
      console.error(err); setCloudStatus(`Cloud: email-link error — ${err.code||err.message}`, false);
    }
  }
})();

/* Send email link */
stats.btnSendLink.onclick = async ()=>{
  try{
    const email=(stats.emailBox.value||'').trim();
    if(!email){ alert('Enter your email.'); stats.emailBox.focus(); return; }
    const actionCodeSettings={ url: currentReturnUrl(), handleCodeInApp: true };
    await sendSignInLinkToEmail(auth, email, actionCodeSettings);
    window.localStorage.setItem('emailForSignIn', email);
    alert('Sign-in link sent. Open it on each device to link them, then tap Sync Now.');
  }catch(err){
    console.error(err); alert('Send link failed: ' + (err.code||err.message));
  }
};
stats.btnSignOut.onclick = ()=> signOut(auth).catch(console.error);

/* ---------- Firestore Sync (shared UID) ---------- */
async function syncWithCloud(){
  if(!currentUID){ setCloudStatus('Cloud: not signed in', false); return; }
  try{
    setCloudStatus('Cloud: syncing…', true);
    const sessions=await idbAll('sessions'); const putts=await idbAll('putts');

    async function batchWrite(docs, makePathAndData){
      const CHUNK=400;
      for(let i=0;i<docs.length;i+=CHUNK){
        const chunk=docs.slice(i,i+CHUNK); const batch=writeBatch(db);
        chunk.forEach(d=>{ const {path,data}=makePathAndData(d); batch.set(doc(db,...path), data, {merge:true}); });
        await batch.commit();
      }
    }
    await batchWrite(sessions, s=>({ path:['users',currentUID,'sessions',s.id], data:s }));
    await batchWrite(putts, p=>({ path:['users',currentUID,'putts', (p.uid?String(p.uid):`p_${p.sessionId||'x'}_${p.ts||Date.now()}`)], data:p }));

    // Pull & merge
    const cs=await getDocs(collection(db,'users',currentUID,'sessions'));
    const cp=await getDocs(collection(db,'users',currentUID,'putts'));
    const cloudSessions=cs.docs.map(d=>d.data()); const cloudPutts=cp.docs.map(d=>d.data());

    const dbi=await openDB();
    await new Promise((res,rej)=>{
      const tx=dbi.transaction(['sessions','putts'],'readwrite'); const stS=tx.objectStore('sessions'); const stP=tx.objectStore('putts');
      const puttKeys=new Set(); const cur=dbi.transaction('putts','readonly').objectStore('putts').openCursor();
      cur.onsuccess=(ev)=>{const c=ev.target.result; if(c){puttKeys.add((c.value.sessionId||'')+'|'+(c.value.ts||'')); c.continue();}};
      cur.oncomplete=()=>{
        cloudSessions.forEach(s=>stS.put(s));
        cloudPutts.forEach(p=>{ const key=(p.sessionId||'')+'|'+(p.ts||''); if(!puttKeys.has(key)) stP.add(p); });
      };
      tx.oncomplete=()=>{dbi.close();res();}; tx.onerror=()=>rej(tx.error||new Error('cloud merge failed'));
    });

    await initStats();
    setCloudStatus('Cloud: ok', true);
  }catch(err){ console.error(err); setCloudStatus(`Cloud: ${err.code||err.message}`, false); }
}
$('#msSyncNow').onclick=syncWithCloud; stats.btnSyncNow.onclick=syncWithCloud;

/* Start */
initStats();
</script>
</body>
</html>
